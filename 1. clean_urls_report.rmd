---
title: "Report: extraction of urls for IMF programs"
author: "Manuel BÃ©tin"
date: "21/11/2019"
output:
  html_document:
    number_sections: TRUE
    theme: sandstone
    highlight: tango
    code_folding: "hide"
abstract: "Overview of the extraction of urls using all_links.csv. The following code clean the urls by finding the country, the type of document and the type of program from the metadata. \n"

---


```{r setup,include=F}

#includes:
#      after_body: footer.html
##install common packages
library("SetUpProject") #make sure you have the library

packages <- c("dplyr",
              'tictoc',
              "rio",
              "tidytext",
              "stringr",
              "stringi",
              "tidyr",
              "ggplot2",
              "lubridate",
              'crayon',
              "DT",
              "plotly",
              "TextMiningCrisis") #make sure you have the library 

## load common packages
load.my.packages(packages)

#-----------
clean_IMF_urls=function(file){
  #label the type of EBS: cleaned, correction or supplement
  EBS_files=file %>% filter(str_detect(hierarchy,"EBS"))
  EBS_files_cor=EBS_files %>% filter(str_detect(hierarchy,"Cor")) %>% mutate(type_hierarchy="Correction")
  EBS_files_sup=EBS_files %>% filter(str_detect(hierarchy,"Sup")) %>% mutate(type_hierarchy="a_Supplement")
  EBS_files_clean=EBS_files %>% filter(!(str_detect(hierarchy,"Sup") | str_detect(hierarchy,"Cor"))) %>% mutate(type_hierarchy="b_Clean")
  final_dt=rbind(EBS_files_clean,EBS_files_cor,EBS_files_sup)
  final_dt=final_dt %>% mutate(date=as.Date(date,format="%b %d %Y"))
  final_dt
}

find_keyword_list=function(files){
  #find the full set of keywords available in the metadata of the documents
  keywords=paste0(files$keywords,collapse=", ")
  #keywords=clean_text(keywords)
  keywords=strsplit(keywords, ",")[[1]]
  keywords=data.frame(keywords)
  colnames(keywords)="keywords"
  
  summary_keywords=keywords %>% group_by(keywords) %>% summarize(n=n()) %>% arrange(-n) %>% mutate(keywords=str_replace_all(keywords,"\\[",''),
                                                                                                   keywords=str_replace_all(keywords,"\\]",''),
                                                                                                   keywords=str_replace_all(keywords,"\\'",''),
                                                                                                   keywords=substr(keywords,2,100))
  return(list(IMF_keywords=summary_keywords$keywords,summary_keywords=summary_keywords))
  
}

```

```{r import data,warning=F}


links_all="all_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
links_all=links_all %>% dplyr::select(-V1)
links_all1=clean_IMF_urls(links_all)


links_all="IMFEFF_bef1980_Reviews_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
names(links_all)[9]="title_1"
links_all2=clean_IMF_urls(links_all)


links_all="IMFSBA_bef1980_Requests_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
names(links_all)[9]="title_1"
links_all3=clean_IMF_urls(links_all)


links_all="IMFSBA_bef1980_Reviews_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
names(links_all)[9]="title_1"
links_all4=clean_IMF_urls(links_all)

links_all="IMFFCL_Requests_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
names(links_all)[9]="title_1"
links_all5=clean_IMF_urls(links_all)

links_all="IMFFCL_Reviews_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
names(links_all)[9]="title_1"
links_all6=clean_IMF_urls(links_all)

links_all="IMFSBA_aft2000_Requests_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
names(links_all)[9]="title_1"
links_all7=clean_IMF_urls(links_all)

links_all="IMFSBA_aft2000_Reviews_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
names(links_all)[9]="title_1"
links_all8=clean_IMF_urls(links_all)

links_all="IMFEFF_aft2000_Requests_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
names(links_all)[9]="title_1"
links_all9=clean_IMF_urls(links_all)

links_all="IMFEFF_bef1983_Requests_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
names(links_all)[9]="title_1"
links_all10=clean_IMF_urls(links_all)

links_all="IMFSBA_aft2003_Requests_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
names(links_all)[9]="title_1"
links_all11=clean_IMF_urls(links_all)



links_all="IMFSBA_aft2003_Requests_links.csv"#
links_all=rio::import(paste0("files/IMF_urls_raw/",links_all))
names(links_all)[9]="title_1"
links_all12=clean_IMF_urls(links_all)

url_links=rbind(links_all1,links_all2,links_all3,links_all4,links_all5,links_all6,links_all7,links_all8,links_all9,links_all10,links_all11,links_all12)
url_links=url_links %>% mutate(year=lubridate::year(date))

IMF_programs=rio::import("files/IMF_programs_dates.xlsx")
IMF_links_old=rio::import("files/IMF_Requests_1960_2014_urls.xlsx")
```

```{r clean urls,warning=F}

urls_clean=url_links #%>% filter(type_hierarchy %in% c("Clean")) #select links corresponding to EBS with no correction or supplements
myIMF_keywords=find_keyword_list(urls_clean) #find the list of keywords across the dataset

#transform title to lower case
urls_clean=urls_clean %>% mutate(title=tolower(title))

#urls_clean= urls_clean %>% filter(!(str_detect(hierarchy,"Cor") | str_detect(hierarchy,"Sup")))
#urls_clean= urls_clean %>% filter(!(str_detect(hierarchy,"Cor")))

urls_clean= urls_clean %>% filter((str_detect(hierarchy,"EBS")))

datatable(urls_clean %>% group_by(type_hierarchy) %>% summarize(n=n()))

```


# Find iso3 codes

Find country name from title and transform to iso3 code

```{r country names, warning=F}

urls_clean=urls_clean %>% mutate(title2=title) %>% separate(title2,into="iso3",sep="-") %>% dplyr::select(iso3,date,everything())
urls_clean=urls_clean %>% mutate(iso3=str_trim(iso3,"both"))
ctries=countrycode::countrycode(list_countries(),origin="iso3c",destination="country.name") %>% tolower()

nonstandard_ctrynames=c(COD="zaire",SOM="somalia",YEM="yemen arab republic","yugoslavia",CIV="ivory coast",WSM="western samoa",HUN="hungarian people's republic",KOR="korea",
                        MMR="burma",VCT="st. vincent and the grenadines",GMB="the gambia",CIV="cote d'ivoire",COD="people's republic of the congo",CHN="people's republic of china",
                        EGY="arab republic of egypt",MOZ="people's republic of mozambique",TTO="trinidad and tobago",STP="sao tome and principe",LAO="lao people's democratic republic",
                        MOZ="republic of mozambique",POL="republic of poland",CZE="czech and slovak federal republic",RUS='russian federation',CZE="czech republic",SVK="slovak republic",
                        LVA='republic of latvia',KGZ="kyrgyz republic",MDA="republic of moldova",VNM="viet nam",LTU="republic of lithuania",EST="republic of estonia",KAZ="republic of kazakhstan",
                        MKD="former yugoslav republic of macedonia",COG="republic of congo",HRV="republic of croatia",ARM="republic of armenia",BLR="republic of belarus",UZB="republic of uzbekistan",
                        AZE="azerbaijan republic",GEO="republic of georgia",KAZ="republic of kazakstan",BIH="republic of bosnia and herzegovina",YEM="republic of yemen",TJK="republic of tajikistan",
                        BIH="bosnia and herzegovina",KOR="republic of korea",KNA="st. kitts and nevis",GNQ="guinea bissau",MEX="mexico <U+0097> arrangement under the flexible credit line",
                        MEX="mexico<U+0097>review under the flexible credit line arrangement",COL="colombia<U+0097>review under the flexible credit line arrangement")

nonstandard_ctrynames2=as.data.frame(nonstandard_ctrynames)
nonstandard_ctrynames2$iso3c=names(nonstandard_ctrynames)
names(nonstandard_ctrynames2)=c("iso3_new","iso3c")
nonstandard_ctrynames2=nonstandard_ctrynames2 %>% mutate(iso3_new=as.character(iso3_new))

urls_clean=urls_clean %>% mutate(iso3_error=ifelse(!iso3 %in% c(ctries,nonstandard_ctrynames),iso3,""),
                                 iso3_new=as.character(ifelse(iso3 %in% c(ctries,nonstandard_ctrynames),iso3,"")))

urls_clean=urls_clean %>% left_join(nonstandard_ctrynames2,by=c("iso3_new"))

#correct manually some cases and transform to iso3c
urls_clean=urls_clean %>% mutate(iso3c=ifelse(is.na(iso3c),countrycode::countrycode(iso3_new,origin="country.name",destination="iso3c"),iso3c),
                                 iso3c=ifelse(str_detect(iso3,"mexico"),"MEX",iso3c),
                                 iso3c=ifelse(str_detect(iso3,"philippines"),"PHL",iso3c),
                                 iso3c=ifelse(str_detect(iso3,"macedonia"),"MKD",iso3c),
                                 iso3c=ifelse(str_detect(iso3,"yugoslavia"),"YUG",iso3c))

urls_clean %>% filter(is.na(iso3c))  %>% summarize(urls_with_no_ctry_names=n())

urls_clean=urls_clean %>% filter(!is.na(iso3c)) %>%
  dplyr::select(iso3c,-iso3_new,-iso3,date,everything()) %>% dplyr::select(-c(iso3_error,iso3_new))

a=urls_clean$iso3c %>% unique()

b=IMF_programs$ISO3_Code %>% unique()

```

countries present in urls but missing in the original programs

```{r ,results='asis'}
setdiff(a,b)

```

"countries present in liste of programs but missing in the urls

```{r ,results='asis'}

setdiff(b,a)
```

# Find type of document:

From the metadata in the title and keywords we extract the type of documents of each url.

- requests
- reviews
- use fund
- cancelation
- cancelation and request
- compensatory
- extension
- performance criteria
- waiver

```{r find requests}
# find the requests ---------

urls_clean=urls_clean %>% mutate(type_doc=ifelse(str_detect(title,"request") & !str_detect(title,"waiver"),"request",NA),
                                 type_doc=ifelse(str_detect(title,'arrangement under the flexible credit line'),"request",type_doc),
                                 type_doc=ifelse(str_detect(keywords,'requests'),"request",type_doc),
                                 type_doc=ifelse(str_detect(keywords,'Letters of Intent'),"request",type_doc),
                                 type_doc=ifelse(str_detect(keywords,'arrangement texts'),"request",type_doc),
                                 type_doc=ifelse(str_detect(title,'letter on economic policy'),"request",type_doc),
                                 type_doc=ifelse(year<=1983 & str_detect(title,'stand-by arrangement') & !str_detect(title,'review'),"request",type_doc),
                                 type_doc=ifelse(year<=1983 & str_detect(title,'extended arrangement') & (!str_detect(title,'review') | !str_detect(title,'request for modification') | !str_detect(title,'waiver') ),"request",type_doc),
                                 type_doc=ifelse(year<=1983 & str_detect(title,'extended fund facility') & (!str_detect(title,'review') | !str_detect(title,'request for modification')),"request",type_doc))

```

```{r find reviews}
# find the number of the review ---------
urls_clean=urls_clean %>% mutate(Review_number=ifelse(str_detect(title,"review") & str_detect(title,"first"),"review_1",
                                                      ifelse(str_detect(title,"review") & str_detect(title,"second"),"review_2",
                                                             ifelse(str_detect(title,"review") & str_detect(title,"third"),"review_3",
                                                                    ifelse(str_detect(title,"review") & str_detect(title,"fourth"),"review_4",
                                                                           ifelse(str_detect(title,"review") & str_detect(title,"fifth"),"review_5",
                                                                                  ifelse(str_detect(title,"review") & str_detect(title,"sixth"),"review_6",
                                                                                         ifelse(str_detect(title,"review") & str_detect(title,"seventh"),"review_8",
                                                                                                ifelse(str_detect(title,"review") & str_detect(title,"eight"),"review_9",
                                                                                                       ifelse(str_detect(title,"review") & str_detect(title,"ninth"),"review_10",
                                                                                                              ifelse(str_detect(title,"review") & str_detect(title,"tenth"),"review_11",NA)))))))))))

urls_clean=urls_clean %>% mutate(Review_number=ifelse(str_detect(title,"review") & str_detect(title,"midterm"),"review_midterm",Review_number),
                                 Review_number=ifelse(str_detect(title,"review") & str_detect(title,"review") & is.na(Review_number),"review",Review_number),
                                 type_doc=ifelse((!is.na(Review_number) & is.na(type_doc)) | (str_detect(keywords,"reviews") | str_detect(title,"review")),"review",type_doc),
                                 type_doc=ifelse(!is.na(Review_number) & str_detect(title,"request") & !str_detect(title,"waiver"),"request and review",type_doc))


```

```{r find use of fund}
# find use of fund ressource -------

urls_clean=urls_clean %>% mutate(type_doc=ifelse(is.na(type_doc) & str_detect(title,"use of fund resources"),"Use fund",type_doc))

```

```{r find cancelations}
# find cancellations -------
urls_clean=urls_clean %>% mutate(type_doc=ifelse(str_detect(title,"cancellation"),"cancelation",type_doc),
                                 type_doc=ifelse(str_detect(title,"cancellation") & (str_detect(title,"request") | str_detect(title,"flexible credit line") ),"cancelation and request",type_doc))

```

```{r extensions}
# find extensions -------

urls_clean=urls_clean %>% mutate(type_doc=ifelse(! is.na(type_doc) & (str_detect(title,"prolongation") | str_detect(title,"extension") | str_detect(title,"lengthening")| str_detect(title,"augmentation")),"extension",type_doc))

```

```{r compensatory}
# find compensatory -------

urls_clean=urls_clean %>% mutate(type_doc=ifelse(str_detect(title,"compensatory"),"compensatory",type_doc))

urls_clean=urls_clean %>% mutate(type_doc=ifelse(is.na(type_doc) & str_detect(title,"performance criteria"),"performance criteria",type_doc))
urls_clean=urls_clean %>% mutate(performance_criteria=ifelse(str_detect(title,"performance criteria") | str_detect(keywords,"performance criterion"),"performance criteria",NA))
urls_clean=urls_clean %>% mutate(waiver=ifelse(str_detect(title,"waiver"),"waiver",NA))
urls_clean=urls_clean %>% mutate(modification=ifelse(str_detect(title,"request for modification"),"modification",NA))

urls_clean=urls_clean %>% mutate(type_doc=ifelse(str_detect(title,"waiver") & str_detect(title,"performance criteria") & is.na(type_doc),"performance criteria and waiver",type_doc),
                                 type_doc=ifelse(str_detect(title,"waiver") & is.na(type_doc),"waiver",type_doc))


```


```{r purchase transaction}

urls_clean=urls_clean %>% mutate(type_doc=ifelse(!is.na(type_doc) & (str_detect(title,"purchase transaction")),"purchase transac",type_doc))

```


Targeted number of programs and already downloaded programs

```{r summary type of document on old extraction}

datatable(IMF_links_old %>% group_by(variable) %>%  mutate(url_ok=ifelse(!is.na(link),"downloaded","missing")) %>% ungroup() %>% group_by(variable,url_ok) %>% summarize(n=n()))

```


Numbers of programs on the new extraction

```{r summary type of document on new extraction}

datatable(urls_clean %>% group_by(type_doc) %>% summarize(n=n()))

```


```{r summary type of document on new extraction by type of hierarchy}
datatable(urls_clean %>% group_by(type_doc,type_hierarchy) %>% summarize(n=n()))
```


# Find the type of program

From the title and the keywords we extract the type of program and found 16 types: 

1. Stand-by arrangement (SBA)
2. Extended arrangement (EA)
3. Compensatory financing (CF)
4. Buffer stock financing facility (BSFF)
5. ESAF arrangement (ESAF)
6. Emergency purchase transactions (EPT)
7. Structural ajustement arrangement  (SAA)
8. Compensatory and Contingency Financing Facility (CCFF)
9. Systemic Transformation Facility (STF)
10. Flexible credit line (FCL)
11. Poverty Reduction and Growth Facility (PRGF)
12. Precautionary and Liquidity Line (PLL)
13. SAF arrangement (SAF)
14. first credit tranche (FCT)
15. Extended Credit Facility (ECF)
16. Extended fund facility (EFF)

```{r find type of program}
# type of program --------

urls_clean=urls_clean %>% mutate(type_program=ifelse(str_detect(keywords,"Extended fund facility") | str_detect(title,"extended fund facility"),"EFF",
                                                            ifelse(str_detect(keywords,"ESAF arrangement"),"ESAF",
                                                                   ifelse(str_detect(keywords,"Systemic Transformation Facility"),"STF",
                                                                          ifelse(str_detect(keywords,"Poverty Reduction and Growth Facility"),"PRGF",
                                                                                 ifelse(str_detect(keywords,"Flexible credit line"),"FCL",
                                                                                        ifelse(str_detect(keywords,"Precautionary and Liquidity Line") | str_detect(keywords,"Precautionary Credit Line") ,"PLL",
                                                                                               ifelse(str_detect(keywords,"SAF arrangement"),"SAF",
                                                                                                      ifelse(str_detect(keywords,"Stand-by arrangement") | str_detect(keywords,"Stand-By Arrangement") | str_detect(title,"stand-by arrangement"),"SBA",
                                                                                                             ifelse(str_detect(keywords,"Extended arrangement") | str_detect(keywords,"extended arrangement") | str_detect(title,"extended arrangement"),"EA","Other"))))))))))


# urls_clean=urls_clean %>% mutate(type_program=ifelse(type_program=="Other" & str_detect(keywords,"Purchases under compensatory financing"),"CF",
#                                                      ifelse(type_program=="Other" & str_detect(keywords,"Buffer Stock Financing Facility"),"BSFF",
#                                                             ifelse(type_program=="Other" & str_detect(keywords,"Buffer Stock Financing Facilityg"),"BSFF"))))

# 
# 
# urls_clean=urls_clean %>% mutate(type_program=ifelse(str_detect(keywords,"Extended arrangement"),"EA",
#                                                      ifelse(str_detect(keywords,"Stand-by arrangement") | str_detect(keywords,"Stand-By Arrangements"),"SBA",
#                                                             ifelse(str_detect(keywords,"Purchases under compensatory financing"),"CF",
#                                                                    ifelse(str_detect(keywords,"Buffer Stock Financing Facility"),"BSFF",
#                                                                           ifelse(str_detect(keywords,"ESAF arrangement"),"ESAF",
#                                                                                  ifelse(str_detect(keywords,"Emergency purchase transactions"),"EPT",
#                                                                                         ifelse(str_detect(keywords,"Structural adjustment arrangement requests"),"SAA",
#                                                                                                ifelse(str_detect(keywords,"Purchases under Compensatory and Contingency Financing Facility") | str_detect(keywords,"Compensatory and Contingency Financing Facility"),"CCFF",
#                                                                                                       ifelse(str_detect(keywords,"Systemic Transformation Facility"),"STF",
#                                                                                                              ifelse(str_detect(keywords,"Emergency assistance") | str_detect(keywords,"Post-conflict emergency assistance"),"EAssist",
#                                                                                                                     ifelse(str_detect(keywords,"Poverty Reduction and Growth Facility"),"PRGF",
#                                                                                                                            ifelse(str_detect(keywords,"Flexible credit line"),"FCL",
#                                                                                                                                   ifelse(str_detect(keywords,"Precautionary and Liquidity Line") | str_detect(keywords,"Precautionary Credit Line") ,"PLL",
#                                                                                                                                          ifelse(str_detect(keywords,"SAF arrangement"),"SAF",
#                                                                                                                                                 ifelse(str_detect(keywords,"first credit tranche"),"FCT",
#                                                                                                                                                        ifelse(str_detect(keywords,"Extended Credit Facility"),"ECF",NA)))))))))))))))))


urls_clean=urls_clean %>% mutate(type_program=ifelse(is.na(type_program) & str_detect(title,"extended fund facility"),"EFF",type_program),
                                 type_program=ifelse(is.na(type_program) & str_detect(title,"extended arrangement"),"EA",type_program))

```


```{r filter only relevant programs}

#remove programs not corresponding to any of the above programss

urls_clean=urls_clean %>% filter(!is.na(type_program))

#remove corrections

urls_clean= urls_clean %>% filter(!is.na(type_doc))
#urls_clean= urls_clean %>% filter(!(str_detect(hierarchy,"Cor") | str_detect(hierarchy,"Sup") | is.na(type_doc)))

urls_clean=urls_clean %>% 
  dplyr::select(iso3c,date,hierarchy,title,type_program,type_doc,Review_number,performance_criteria,waiver,modification,type_hierarchy,everything()) %>%
  arrange(iso3c,date)


#remove duplicates

urls_clean=urls_clean %>% dplyr::select(-c(cfs,subject,title_1))
urls_clean=urls_clean %>% distinct()

# summary number of documents by type of programs

#View(urls_clean %>% filter(year<2000 & year>1983))
#(urls_clean %>% filter(iso3c=="TUR") %>% arrange(year))$year %>% unique()
#(urls_clean %>% filter(iso3c=="TUR" & type_doc=="request") %>% arrange(year))$year %>% unique()


datatable(urls_clean %>% group_by(type_program,type_doc) %>% summarize(n=n()))

```

# Merge datasets of requests with new documents

```{r merge request and urls}

df1 <- urls_clean
df2 <- IMF_programs
# merge tables to match requests with docum


df2 <- df2 %>%
  rename(startdate = Period) %>%
  rename(enddate = Date_Expiration) %>%
  rename(ID = ISO3_Code) 

df2=df2 %>%
  mutate(startdate_ext=startdate %m-% months(2),
         enddate_ext=enddate %m-% months(2))

df1 <- df1 %>%
  rename(Loss_Date = date) %>%
  #rename(perf_crit = Performance_criteria) %>%
  rename(perf_criterct = performance_criteria) %>%
  rename(ID = iso3c)

# Joining data

dt_merged <- full_join(df1, df2, by="ID") %>% 
  filter(Loss_Date >= startdate_ext & Loss_Date <= enddate_ext)
#Keeping those who don't match
liste <- dt_merged$reference

#
Nonmatching_files <- df1 %>% dplyr::filter(!reference %in% liste)

urls_clean=dt_merged

```

```{r description merge}

N_docs_by_programs=dt_merged %>% filter(type_hierarchy=="b_Clean") %>%
  group_by(file) %>% summarize(n_docs=n(),
                               type_docs=paste(unique(paste0(type_program,'(',type_doc,")")),collapse=","))

```

# Description of available data and comparison with benchmark

Compare the number of documents extracted with the number of agreed programs and the number of requests already downloaded.

- Cleaning of document is necessary because more than half documents are corrections, supplements or non related to a specific country
- Clear problem between 2000 and 2008 with no results
- Clear missings in the 1980

```{r descriptive stats of urls}

#name_links_dt="all_links.csv"#"IMFECF_Requests_links.csv" #"IMFSBA_Reviews_links.csv"#"all_links.csv"
#url_links=rio::import(paste0("files/IMF_urls_raw/",name_links_dt))
#head(url_links)
url_links=url_links %>% mutate(date=as.Date(date,format="%b %d %Y")) %>% mutate(year=lubridate::year(date))
names(urls_clean)
urls_clean=urls_clean  %>% mutate(date=as.Date(Loss_Date,format="%b %d %Y")) %>% mutate(year=lubridate::year(date))

links_by_year=url_links %>% group_by(year) %>% summarize(n=n())
clean_links_by_year=urls_clean %>% group_by(year) %>% summarize(n=n())
ggplotly(ggplot()+
  geom_bar(data=links_by_year,stat="identity",aes(x=year,y=n,fill="raw"))+
  geom_bar(data=clean_links_by_year,stat="identity",aes(x=year,y=n,fill="clean"))+
  labs(title="All urls")+
  theme_bw()
)

#links_by_year=url_links %>% group_by(year) %>% filter(type_doc=="review") %>% summarize(n=n())
clean_links_by_year=urls_clean %>% group_by(year) %>% filter(type_doc=="review") %>% summarize(n=n())

ggplotly(ggplot()+
  #geom_bar(data=links_by_year,stat="identity",aes(x=year,y=n,fill="raw"))+
  geom_bar(data=clean_links_by_year,stat="identity",aes(x=year,y=n,fill="clean"))+
  labs(title="Only Reviews")+
  theme_bw())

```


## Requests

### Requests: All program type

```{r Describe all requests,results='asis',warning=F}

IMF_links_old_by_year=IMF_links_old %>% mutate(year=lubridate::year(Period)) %>% group_by(year) %>% summarize(n=n())


programs_by_year=IMF_programs  %>% mutate(year=lubridate::year(Period)) %>% group_by(year) %>% summarize(n=n())
links_by_year=urls_clean %>% group_by(type_hierarchy,year) %>% filter(type_doc %in% c("request","request and review","cancelation and request")) %>% summarize(n=n())
ggplotly(ggplot()+
 geom_bar(data=IMF_links_old_by_year,stat="identity",aes(x=year,y=n,fill="old_urls"),color="black",alpha=0.5)+
  geom_bar(data=links_by_year,stat="identity",aes(x=year,y=n,fill=type_hierarchy),color="black")+
  geom_point(data=programs_by_year,stat="identity",aes(x=year,y=n),color="black",size=2)+
  labs(title="Requests")+
 # lims(y=c(0,45))+
  theme_bw())

```

### Requests by type of programs

- SBA programs between 1983 and 1999 are ok
- EFF programs between 1983 and 1999 are ok

```{r Describe requests by programs}

IMF_links_old_by_year=IMF_links_old %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFSBA") %>% group_by(year) %>% summarize(n=n())
programs_by_year=IMF_programs  %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFSBA") %>% group_by(year) %>% summarize(n=n())
links_by_year=urls_clean %>% group_by(type_hierarchy,year) %>% filter(type_doc%in% c("request","request and review","cancelation and request") & type_program=="SBA") %>% summarize(n=n())
ggplotly(ggplot()+
  geom_bar(data=programs_by_year,stat="identity",aes(x=year,y=n,fill="target"),color="black",alpha=0.5)+
  geom_bar(data=links_by_year,stat="identity",aes(x=year,y=n,fill=type_hierarchy),color="black")+
   geom_point(data=programs_by_year,stat="identity",aes(x=year,y=n),color="black",size=2)+
  labs(title="Requests for SBA")+
  #lims(y=c(0,45))+
  theme_bw())

IMF_links_old_by_year=IMF_links_old %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFEFF") %>% group_by(year) %>% summarize(n=n())
programs_by_year=IMF_programs  %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFEFF") %>% group_by(year) %>% summarize(n=n())
links_by_year=urls_clean %>% group_by(type_hierarchy,year) %>% filter(type_doc%in% c("request","request and review","cancelation and request") & type_program %in% c("EA","EFF")) %>% summarize(n=n())
ggplotly(ggplot()+
  geom_bar(data=programs_by_year,stat="identity",aes(x=year,y=n,fill="target"),color="black",alpha=0.5)+
  geom_bar(data=links_by_year,stat="identity",aes(x=year,y=n,fill=type_hierarchy),color="black")+
   geom_point(data=programs_by_year,stat="identity",aes(x=year,y=n),color="black",size=2)+
  labs(title="Requests for Extended arrangements")+
  #lims(y=c(0,45))+
  theme_bw())

IMF_links_old_by_year=IMF_links_old %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFFCL") %>% group_by(year) %>% summarize(n=n())
programs_by_year=IMF_programs  %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFFCL") %>% group_by(year) %>% summarize(n=n())
links_by_year=urls_clean %>% group_by(type_hierarchy,year) %>% filter(type_doc%in% c("request","request and review","cancelation and request") & type_program %in% c("FCL")) %>% summarize(n=n())
ggplotly(ggplot()+
  geom_bar(data=programs_by_year,stat="identity",aes(x=year,y=n,fill="target"),color="black",alpha=0.5)+
  geom_bar(data=links_by_year,stat="identity",aes(x=year,y=n,fill=type_hierarchy),color="black")+
   geom_point(data=programs_by_year,stat="identity",aes(x=year,y=n),color="black",size=2)+
  labs(title="Requests for flexible credit lines")+
  #lims(y=c(0,45))+
  theme_bw())

IMF_links_old_by_year=IMF_links_old %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFSAF") %>% group_by(year) %>% summarize(n=n())
programs_by_year=IMF_programs  %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFSAF") %>% group_by(year) %>% summarize(n=n())
links_by_year=urls_clean %>% group_by(type_hierarchy,year) %>% filter(type_doc%in% c("request","request and review","cancelation and request") & type_program =="ESAF") %>% summarize(n=n())
ggplotly(ggplot()+
  geom_bar(data=programs_by_year,stat="identity",aes(x=year,y=n,fill="target"),color="black",alpha=0.5)+
  geom_bar(data=links_by_year,stat="identity",aes(x=year,y=n,fill=type_hierarchy),color="black")+
   geom_point(data=programs_by_year,stat="identity",aes(x=year,y=n),color="black",size=2)+
  labs(title="Requests for structural adjustment facility")+
  #lims(y=c(0,45))+
  theme_bw())

```

## Reviews

```{r review numbers}

details_N_reviews=urls_clean %>% filter(type_doc %in% c("review","request and review","request") &
                          type_hierarchy=="b_Clean") %>% 
  mutate(Review_number2=str_remove(Review_number,"review_"),
         Review_number2=ifelse(Review_number2=="review",1,Review_number2),
         Review_number2=ifelse(type_doc=="request",0,Review_number2),
         Review_number2=ifelse(Review_number2=="midterm",1,Review_number2),
         Review_number2=as.numeric(Review_number2),
         Review_number2=ifelse(Review_number2>=4,4,Review_number2)
        ) %>% group_by(Review_number2,type_program) %>% summarize(n=n())
                                                     
ggplot(details_N_reviews)+
  geom_bar(stat="identity",aes(x=paste0("Review_",Review_number2),y=n,fill=type_program))+
  #geom_label(aes(x=paste0("Review_",Review_number2),y=n,label=n))+
  labs(x=NULL)+
  theme_bw()+
  theme(legend.position="bottom")

```


```{r Describe reviews by programs}

IMF_links_old_by_year=IMF_links_old %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFSBA") %>% group_by(year) %>% summarize(n=n())
programs_by_year=IMF_programs  %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFSBA") %>% group_by(year) %>% summarize(n=n())
links_by_year=urls_clean %>% group_by(type_hierarchy,year) %>% filter(type_doc=="review" & type_program=="SBA") %>% summarize(n=n())
ggplotly(ggplot()+
  #geom_bar(data=programs_by_year,stat="identity",aes(x=year,y=n,fill="target",alpha=0.5),color="black")+
  geom_bar(data=links_by_year,stat="identity",aes(x=year,y=n,fill=type_hierarchy),color="black")+
  # geom_point(data=programs_by_year,stat="identity",aes(x=year,y=n),color="black",size=2)+
  labs(title="Reviews for SBA")+
 # lims(y=c(0,45))+
  theme_bw())

IMF_links_old_by_year=IMF_links_old %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFEFF") %>% group_by(year) %>% summarize(n=n())
programs_by_year=IMF_programs  %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFEFF") %>% group_by(year) %>% summarize(n=n())
links_by_year=urls_clean %>% group_by(type_hierarchy,year) %>% filter(type_doc=="review" & type_program %in% c("EA","EFF")) %>% summarize(n=n())
ggplotly(ggplot()+
  #geom_bar(data=programs_by_year,stat="identity",aes(x=year,y=n,fill="target",alpha=0.5),color="black")+
  geom_bar(data=links_by_year,stat="identity",aes(x=year,y=n,fill=type_hierarchy),color="black")+
  # geom_point(data=programs_by_year,stat="identity",aes(x=year,y=n),color="black",size=2)+
  labs(title="Reviews for Extended arrangements")+
 # lims(y=c(0,45))+
  theme_bw())

IMF_links_old_by_year=IMF_links_old %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFFCL") %>% group_by(year) %>% summarize(n=n())
programs_by_year=IMF_programs  %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFFCL") %>% group_by(year) %>% summarize(n=n())
links_by_year=urls_clean %>% group_by(type_hierarchy,year) %>% filter(type_doc=="review" & type_program %in% c("FCL")) %>% summarize(n=n())
ggplotly(ggplot()+
  #geom_bar(data=programs_by_year,stat="identity",aes(x=year,y=n,fill="target",alpha=0.5),color="black")+
  geom_bar(data=links_by_year,stat="identity",aes(x=year,y=n,fill=type_hierarchy),color="black")+
  #geom_point(data=programs_by_year,stat="identity",aes(x=year,y=n),color="black",size=2)+
  labs(title="Reviews for flexible credit lines")+
#  lims(y=c(0,45))+
  theme_bw())

IMF_links_old_by_year=IMF_links_old %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFSAF") %>% group_by(year) %>% summarize(n=n())
programs_by_year=IMF_programs  %>% mutate(year=lubridate::year(Period)) %>% filter(variable=="IMFSAF") %>% group_by(year) %>% summarize(n=n())
links_by_year=urls_clean %>% group_by(type_hierarchy,year) %>% filter(type_doc=="review" & type_program =="ESAF") %>% summarize(n=n())
ggplotly(ggplot()+
  #geom_bar(data=programs_by_year,stat="identity",aes(x=year,y=n,fill="target",alpha=0.5),color="black")+
  geom_bar(data=links_by_year,stat="identity",aes(x=year,y=n,fill=type_hierarchy),color="black")+
  # geom_point(data=programs_by_year,stat="identity",aes(x=year,y=n),color="black",size=2)+
  labs(title="Reviews for structural adjustment facility")+
#  lims(y=c(0,45))+
  theme_bw())

```


```{r session info,}
sessionInfo()
```

```{r create variables from metadata,eval=F}
type_doc_list=function(){
type_doc=c("Nonapproval recommended by staff",
           'Fund approval extension proposed',
           "Fund approval",
           
           "Letters of Intent",
           'Debt sustainability analysis',
           'Press Releases',
           'ARTICLE VIII',
           "Article IV consultations",
           'Article IV',
           "Staff Reports",
           "Staff appraisals",
           'Post-program monitoring',
           
           'Fund financial position reviews',
           'Fund liquidity position',
           
           "Performance criteria waivers",
           "Performance criteria",
           'Performance clauses',
           "Performance criteria modifications",
           
           "Stand-by arrangement requests",
           "Stand-by arrangement reviews",
           "Stand-by arrangement extension",
           "Stand-by arrangement cancellations",
           "Stand-by arrangement text amendments",
           
           "Extended arrangements",
           'Extended arrangement requests',
           'Extended arrangement cancellations',
           'Extended arrangement text amendments',
           'Extended arrangement reviews',
           "Extended arrangement extension",
           "Extended Fund Facility",
           
           "Extended Credit Facility",
           "Rapid Credit Facility",
           "Emergency assistance",
           
           "ESAF arrangements",
           'ESAF arrangement negotiations missions',
           'ESAF arrangement requests',
           'ESAF arrangement extension',
           
           'Enhanced Structural Adjustment Facility',
           'Structural adjustment arrangement requests',
           "ESAF arrangement reviews",
           'Structural Adjustment Facility',
           
           "Technical assistance",
           'Exogenous Shocks Facility',
           'Standby Credit Facility',
           'Flexible credit line',
           'External contingency mechanisms',
           
           'Commodity stabilization funds',
           'Post-conflict emergency assistance',
           'Compensatory financing of export fluctuations',
           'Compensatory and Contingency Financing Facility',
           'Systemic Transformation Facility',
           'Poverty Reduction and Growth Facility'
            
           )
return(type_doc)
}

type_doc=type_doc_list()

for(i in 1:length(type_doc)){
  namevar=str_replace_all(type_doc[i]," ","_")
  urls_clean=urls_clean %>% mutate(!!namevar:=ifelse(str_detect(keywords,type_doc[i]),1,0))
}

```


```{r export}
rio::export(urls_clean,"files/IMF_urls_clean/Final_links_clean.RData")


```



