---
title: <center> A Narrative Approach to Systemic Crisis </center>
runtime: shiny
output: 
  html_document:
    theme: sandstone
    highlight: tango
---

<!--abstract: "This network shows the ocurrrence, the intensity and correlations between macroeconomic shocks as reported in IMF consultations and reports. Use the slider to select the relevant periods and explore the evolution of systemic crisis across years."
 -->
<style>
.main-container {
    max-width: 2000px;
    max-height: 1500px;
    margin-left: 10;
    margin-right: auto;
}
body {
background-color: lightgrey;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(warning = FALSE)

library(shiny)
library(dplyr)
library(network)
library(GGally)
library(TextMiningCrisis)
library(lubridate)
library(stringr)
library(tidyverse)

mydata=rio::import("../Betin_Collodel/2. Text mining IMF_data/datasets/tagged docs/tf_idf_database.RData")

```


```{r network function}
network_eco_shocks=function(mydata,shocks,min_year=1960,max_year=2016,mymode="target",min_corr=0.1,labelsize="Uniform size"){
  
  
  max_no_1=function(x){
  max(ifelse(x!=1,x,NA),na.rm=T)
}
mean_no_1=function(x){
  mean(ifelse(x!=1,x,NA),na.rm=T)
}
min_no_1=function(x){
  min(ifelse(x!=1,x,NA),na.rm=T)
}


  corr_matrix=mydata %>% ungroup() %>%
    filter(type%in%c("request","consultation","review"))%>% filter(year>min_year & year<max_year) %>%
    dplyr::select(shocks) %>% #rename(Austerity=Fiscal_consolidation,
                              #       High_public_debt=Fiscal_outcomes) %>%
    cor() %>% data.frame()
  
  #average correlation
  avg_corr_matrix=corr_matrix %>% summarize_all(mean_no_1)
  min_corr_matrix=corr_matrix %>% summarize_all(min_no_1)
  max_corr_matrix=corr_matrix %>% summarize_all(max_no_1)
  
  # network analysis
  net = network(corr_matrix,
                #matrix.type = "bipartite",
                names.eval = "weights", 
                directed=T,
                ignore.eval=F)
  
  ## define nodes caracteristics
  intensity=mydata %>% ungroup() %>%
    filter(type%in%c("request","consultation","review"))%>%
    filter(year>min_year & year<max_year) %>% dplyr::select(shocks) %>%
    na.omit() %>% summarize_all(mean)
  
  intensity_all=mydata %>% ungroup() %>%
    filter(type%in%c("request","consultation","review"))%>%
    dplyr::select(shocks) %>%
    na.omit() %>% summarize_all(mean)
  
  net %v% "intensity"=round(intensity/max(intensity_all),2)
  
   net %v% "labelsize"=round(percent_rank(intensity/max(intensity_all)),2)*10
  
  fun=function(x){
    ifelse(x>0,1,0)
  }
  proba=mydata %>% ungroup() %>%
    filter(type%in%c("request","consultation","review"))%>%
    filter(year>min_year & year<max_year) %>% dplyr::select(shocks) %>%
    na.omit() %>% mutate_all(fun) %>%summarize_all(mean)
  
  
  net %v% "proba"=round(percent_rank(data.frame(proba[1,]))*20,0)
  
  net %v% "alphaproba"=ifelse(round(percent_rank(data.frame(proba[1,])),1)<=0.4,0.4,round(percent_rank(data.frame(proba[1,])),1))
  
  typology=typology_categories() %>% filter(variable %in% shocks)
  net %v% "typology"=typology$nature_shock
  
  ## define edge attributes
  
  set.edge.attribute(net, "color", ifelse(net %e% "weights" <=min_corr,"lightgrey",
                                          ifelse(net %e% "weights" > min_corr & net %e% "weights" < 0.2,"darkblue",
                                                 ifelse(net %e% "weights" > 0.2 & net %e% "weights" < 0.5,"orange",
                                                        ifelse(net %e% "weights" > 0.5,"darkred",0)))))
  
  set.edge.attribute(net, "lty", ifelse(net %e% "weights" <min_corr,3,
                                        ifelse(net %e% "weights" > min_corr & net %e% "weights" < 0.2,3,
                                               ifelse(net %e% "weights" > 0.2 & net %e% "weights" < 0.5,1,
                                                      ifelse(net %e% "weights" > 0.5,1,0)))))

  set.edge.attribute(net, "alpha", ifelse(net %e% "weights" <min_corr,0.2,
                                          ifelse(net %e% "weights" > min_corr & net %e% "weights" < 0.5,0.5,
                                                 ifelse(net %e% "weights" > 0.5,1,0))))
  
  set.edge.attribute(net, "abc", ifelse(net %e% "weights">=0.1,net %e% "weights",0.0001)*5)
  
  set.seed(2)
  ggnet2(net,
         mode=mymode,layout.par = list(niter = 300,weights="abc"),
         color="darkred",#"typology",
         node.size =0.001,
         max_size = 15,
         edge.size = "abc",
         #node.alpha = "alphaproba",
         #edge.label = "weights",
         edge.label.alpha = 1,
         edge.label.size = "proba",
         edge.lty = "lty",
         #legend.position = "none",
         alpha=1,
         label.size = ifelse(labelsize=="Uniform size",10,"labelsize"),
         label.alpha = "alphaproba",
         #label.color="Color",
         edge.color = "color",
         edge.alpha = 0.4,
         #edge.label.color = "black",
         #size.zero=T,
         label=T,
        layout.exp = 0.5,
         edge.label.fill = NA
  )+
    theme_grey()+
    labs(x=NULL,y=NULL)+
    #labs(title=paste0("Systemic crisis: ",min_year,"-",max_year),
    #     caption="Edge color, type and size measure the correlation between crisis.
    #            Red links denote correlations higher than 0.5, orange between 0.2 and 0.5,
    #            dotted lines correlations between 0.1 and 0.2.
    #            The size of node measure the average intensity of each crisis.
    #            The opacity of the label denotes the probability of occurence")+
    theme(panel.background = element_rect(fill = "lightgrey",colour="lightgrey"),
          plot.background = element_rect(fill = "lightgrey"),
          legend.position = "none",
          legend.background = element_rect(fill = "lightgrey"))
  #        )
}

```

<center>
```{r Main figure,fig.align="center"}

renderPlot(network_eco_shocks(mydata,
                            c(input$group1,input$group2,input$group3,input$group4),
                            min_year=input$myperiods[1],max_year = input$myperiods[2],
                            mymode=input$mymode,
                            min_corr=input$mincorr,
                            labelsize=input$labelsize
                            ),
           height = 700, width = 1600)
```
</center>
<br>

```{r type visualization}
fluidRow(
  column(4,shiny::selectInput("mymode","Layout of visualization",choice=c("kamadakawai","circle","target")))
  ,column(4,shiny::selectInput("mincorr","Minimum correlation to display edges",choice=seq(0,1,0.1)))
  ,column(4,shiny::selectInput("labelsize","Size of label",choice=c("Uniform size","Function of intensity")))
)
```

<center>
```{r inputs periods}

sliderInput("myperiods",NULL,
            min=1960,
            max=2016,
            value=c(1960,2016),
            step=5,
            width=400,
            dragRange = T,
            animate = animationOptions(interval=4000,loop=T))

```
</center>

<div font-size:0.7em>
**Note:**
*Edge color, type and size measure the correlation between crisis.*
  - *Red links denote correlations higher than 0.5*
  - *Orange links denote correlations between 0.2 and 0.5,*
  - *Dotted green lines denotes correlations between 0.1 and 0.2.*

*The size of node measure the average intensity of each crisis measured as the average of the normalized tf-idf for each of the categories*

*The opacity of the label denotes the probability of occurence measures*
</div>


```{r sample of country, results='asis',eval=F}
paste0((mydata %>% filter(!is.na(Period)))$iso3c %>% unique(),collapse=", ")
```

<hr>

```{r input shocks}

shocks=c('Natural_disaster','Commodity_crisis','Political_crisis','Banking_crisis',
         'Financial_crisis','Inflation_crisis','Trade_crisis','World_outcomes','Contagion',
         'Expectations','Balance_payment_crisis',
         'Severe_recession','Sovereign_default',"Currency_crisis_severe")

fluidRow(column(3,
                checkboxGroupInput("group1", 
                              h3("Real shocks"), 
                              choices = list("Natural_disaster" = "Natural_disaster", 
                                             "Commodity_crisis" = "Commodity_crisis", 
                                             "Political_crisis" = "Political_crisis",
                                             "Severe_recession" = "Severe_recession", 
                                             "Soft_recession" = "Soft_recession", 
                                             "Inflation_crisis" = "Inflation_crisis", 
                                             "Trade_crisis" = "Trade_crisis",
                                             "Social_crisis"="Social_crisis"
                                             ),
                              selected = c("Natural_disaster", "Commodity_crisis", 
                                            "Political_crisis","Trade_crisis",
                                            "Social_crisis","Inflation_crisis","Severe_recession",
                                           "Soft_recession"))),
         column(3,
                checkboxGroupInput("group2", 
                              h3("Fiscal financial shocks"), 
                              choices = list("Sovereign_default"="Sovereign_default",
                                             "Fiscal_outcomes"="Fiscal_outcomes",
                                             "Fiscal_consolidation"="Fiscal_consolidation"                                             ),
                              selected = c("Sovereign_default","Fiscal_outcomes","Fiscal_consolidation"))),
         column(3,
                checkboxGroupInput("group3", 
                              h3("Other financial shocks"), 
                              choices = list( 
                                             "World_outcomes" = "World_outcomes",
                                             "Contagion"="Contagion",
                                             "Expectations"="Expectations",
                                             "Banking_crisis"="Banking_crisis",
                                             "Financial_crisis"="Financial_crisis"
                                             ),
                              selected = c(
                                             "World_outcomes","Contagion", 
                                             "Expectations","Banking_crisis",
                                             "Financial_crisis")
                              
                              )),
         column(3,
                checkboxGroupInput("group4", 
                              h3("External balance shocks"), 
                              choices = list(
                                             "Balance_payment_crisis" = "Balance_payment_crisis",
                                             "Currency_crisis_severe"="Currency_crisis_severe",
                                             "Currency_crisis"="Currency_crisis",
                                             "Reduction_reserves"="Reduction_reserves"
                                             ),
                              selected = c("Balance_payment_crisis",
                                            "Currency_crisis_severe"
                              )))
         )

```

<center>
```{r cluster for systemic index,eval=F}
cluster_crisis=function(mydata,unit_cluster="iso3c",list_vars,Nclusters=6,N_Name_categories=3){
  
  dt=mydata %>% ungroup() %>%  dplyr::select(unit_cluster) %>% unique()
  
  dt_cluster=mydata %>%
    group_by(get(unit_cluster)) %>% 
    dplyr::select(list_vars) %>% na.omit() %>%
    summarize_all(mean) %>% ungroup() #%>% dplyr::select(-unit_cluster)
  dt_cluster=dt_cluster[,-1]
  dt_cluster=scale(dt_cluster)
  
  set.seed(1)
  dt_kmeans=kmeans(dt_cluster,centers=Nclusters, iter.max=500, nstart=1)
  dt_cluster_avg=aggregate(dt_cluster,by=list(dt_kmeans$cluster),FUN=mean)
  
  dt2 <- data.frame(dt_cluster, dt_kmeans$cluster)
  dt_cluster<-cbind(dt,dt2)
  
  # type_crisis_group=dt_cluster %>% group_by(dt_kmeans.cluster) %>% summarize_if(is.numeric,mean) %>%
  #   gather(key="group",value="values",-dt_kmeans.cluster) %>% arrange(dt_kmeans.cluster,-values) %>% group_by(dt_kmeans.cluster) %>%
  #   top_frac(top_perc) %>% summarize(typology=str_replace_all(paste0(group,collapse="/ "),"_"," "))
  # 
  type_crisis_group=dt_cluster %>% group_by(dt_kmeans.cluster) %>% summarize_if(is.numeric,mean) %>%
    gather(key="group",value="values",-dt_kmeans.cluster) %>% arrange(dt_kmeans.cluster,-values) %>% group_by(dt_kmeans.cluster)
  
  #compute the average correlation between all shocks
  avg_corr_matrix=mydata  %>% ungroup() %>% dplyr::select(shocks) %>% na.omit() %>% cor() %>% data.frame() %>% summarize_all(mean)
  avg_corr_matrix=data.frame(t(avg_corr_matrix))
  avg_corr_matrix$group=rownames(avg_corr_matrix)
  names(avg_corr_matrix)[1]="corr.coef"
  
  #compute the exogeneity index
  type_crisis_group=type_crisis_group %>% left_join(avg_corr_matrix,by=c("group")) %>% mutate(systemicity_index=sum(corr.coef*values,na.rm=T))%>% 
 summarize(typology=str_replace_all(paste0(group,collapse="/ "),"_"," "),
           systemicity_index=mean(systemicity_index,na.rm=T) %>% round(.,2)) %>% rowwise() %>%
    mutate(typology=paste0(unlist(str_split(typology,"/"))[1:N_Name_categories],collapse="/"))
  
  ctry_clusters=dt_cluster %>% group_by(dt_kmeans.cluster) %>%
    summarize(ctries=paste(unique(unit_cluster),collapse = ', '),
              n=n()) %>% 
    left_join(type_crisis_group,by="dt_kmeans.cluster") %>%
    rename(group=dt_kmeans.cluster) %>% ungroup() %>% mutate(prop=round(100*n/sum(n),2)) %>%
    dplyr::select(typology,n,prop,systemicity_index) %>% arrange(-prop)
  
  return( list(dt=dt_cluster,arguments_cluster=list_vars,ctry_cluster_summary=ctry_clusters))
}

renderTable({
  
n.clusters=3
cluster=list()
dt=mydata %>% filter(type %in% c("consultation","request","review") & (year>input$myperiods[1] & year<input$myperiods[2])) %>% mutate(Period=year(Period)) %>% 
  group_by(iso3c,year) %>% summarize_at(c(input$group1,input$group2,input$group3,input$group4),sum) %>% mutate(file=paste0(iso3c,"_",year)) %>%  ungroup()%>% dplyr::select(file,c(input$group1,input$group2,input$group3,input$group4))

cluster=cluster_crisis(dt,
                      unit_cluster="file",
                      list_vars = c(input$group1,input$group2,input$group3,input$group4),
                      Nclusters=n.clusters,
                      N_Name_categories = 5)

cluster[[3]] %>% arrange(systemicity_index)
})

```
</center>


```{r,eval=F}
renderTable({
  dt=mydata %>% filter( (year>input$myperiods[1] & year<input$myperiods[2])) %>% ungroup() %>% group_by(iso3c)%>%summarize(n=n())
  #type %in% c("consultation","request","review") &
})
```

